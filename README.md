# Delivery Tools for COVSAFE

## Prerequisites

Before deploying this application, please create your IBM Cloud resource group environment. See [here](https://cloud.ibm.com/docs/account?topic=account-rgs#:~:text=To%20start%20managing%20your%20resource,access%20to%20your%20resource%20groups.).

Also, our installation scripts require your APIKEY. See [here](https://cloud.ibm.com/docs/account?topic=account-userapikey).

Then, please clone our solution that consists of multiple repos in [Hitachi CTI Call For Code COVID-19 Team](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team). Here, we are under the assumption that you clone all repos within `/path/to/COVSAFE`.

In addition to above, please install `python3`, `pipenv`, `node`, and `npm`. Those are required for building and deploying our application.

## Preparation

Before building and deploying our application, you should create some configurations and assets. If you want to apply the "real" sensors with our application, please see the [README for Asset](./data/README.md) and create asset and configuration files needed.

### Create dummy assets

Instead of using the "read" assets, if you want just to run our application with dummy data generated by a script (running on the IBM Cloud Functions periodically), you can skip to read the README and just run scripts shown below.

```sh
cd /path/to/COVSAFE/delivery

# do only when using c4c dummy generator
# generate assets for an imaginary shopping mall
cd ./data/tenants/c4c/tools
npm install && npm start
rm -rf node_modules package-lock.json

# create staff for an imaginary shopping mall
python3 create-assets-staff.py
```

## How to deploy

1. Do commands below and have a coffee break. It creates almost services that we use in IBM Cloud.

```sh
export APIKEY=${YOUR_API_KEY}
cd /path/to/COVSAFE/delivery
cd scripts
pipenv install

# change some variables for your env, like resource group
pipenv run python main.py -o create -p covsafe -t c4c -r jp-tok -g covid-19-dev
```

2. Deploy Functions

See README of each repo to get known how to buid and deploy the functions. All functions require the Cloudant secret, and parts of them need either Cloud Object Storage or Event Streams secret. Please get those secret from `/path/to/COVSAFE/delivery/scripts/.credentials` created after you run `main.py` above.

- `/path/to/COVSAFE/data-proxy`
  - required secrets
    - CLOUDANT_WRITER_CREDENTIALS
    - CLOUDANT_READER_CREDENTIALS
    - COS_READER_CREDENTIALS
    - COS_WRITER_CREDENTIALS
- `/path/to/COVSAFE/risk-calculator`
  - required secrets
    - CLOUDANT_WRITER_CREDENTIALS
    - CLOUDANT_READER_CREDENTIALS
- `/path/to/COVSAFE/risk-notifier`
  - required secrets
    - CLOUDANT_WRITER_CREDENTIALS
    - CLOUDANT_READER_CREDENTIALS
- `/path/to/COVSAFE/data-recorder`
  - required secrets
    - EVENT_STREAMS_READER_CREDENTIALS
    - CLOUDANT_WRITER_CREDENTIALS

3. Deploy COVSAFE-View

Go to `/path/to/COVSAFE/covsafe-view` and see the README. For demonstration, it's recommended to take steps of "How To Build" > "Prod Mode" and "How to Deploy to IBM Cloud."

4. Check it

After your deployment of covsafe-view, covsafe-view URL should be shown with the keyword "Please access to:". Access to the URL with login credentials. If you don't change the default username and password, just use username: "user@fake.email" and password "password".

## How to create dummy data

If you use the tenant "c4c", we prepare the dummy data generator of the sensors that are imagined to be placed at the imaginary shopping mall to have a fun without any physical sensors. If you would like to get it, kick these commands below.

```sh
export APIKEY=YOUR_API_KEY
cd /path/to/COVSAFE/delivery
cd scripts
# change some variables for your env, like resource group
pipenv run python function_dummy_generator.py -o create -r jp-tok -g covid-19-dev -n dummy-generator -p dummy-generator -a dummy-generator -t dummy-generator-trigger -u dummy-generator-rule -c ./.credentials
```

## How to delete COVSAFE

```sh
# dploy covsafe solution
export APIKEY=YOUR_API_KEY
cd /path/to/COVSAFE/delivery
cd scripts
pipenv install

# change some variables for your env, like resource group
pipenv run python main.py -o delete -p covsafe -t c4c -r jp-tok -g covid-19-dev
```
