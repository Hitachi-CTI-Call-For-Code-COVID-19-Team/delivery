# Delivery Tools for COVSAFE

## Prerequisites

Before deploying this application, please create your IBM Cloud resource group environment. See [here](https://cloud.ibm.com/docs/account?topic=account-rgs#:~:text=To%20start%20managing%20your%20resource,access%20to%20your%20resource%20groups.).

Also, our installation scripts require your APIKEY. See [here](https://cloud.ibm.com/docs/account?topic=account-userapikey).

Then, please clone our solution that consists of multiple repos in [Hitachi CTI Call For Code COVID-19 Team](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team). Here, we are under the assumption that you clone all repos within `/path/to/COVSAFE`.

In addition to above, please install `python3`, `pipenv`, `node`, and `npm`. Those are required for building and deploying our application.

## Preparation

COVSAFE is sort of IoT application so that it requires sensors to gather data! You can take two ways:

1. prepare sensors. Items below are supported as of now.

  - [HLS-LFOM5](http://hlds.co.jp/product-eng/)
  - [HLS-LFOM1](http://hlds.co.jp/product-eng/)
  - [MESH LED Tag](https://meshprj.com/en/) - we only support the Orange one

2. use imaginary assets for an imaginary shopping mall

If you want to take the first option, please buy them, then are supposed to create some configurations and assets. please see the [README for Asset](./data/README.md) and create asset and configuration files needed.

Instead of using the "read" assets and take the second option, if you want just to run our application with dummy data generated by a script (running on the IBM Cloud Functions periodically), you can skip to read the README and just run scripts shown below.

```sh
cd /path/to/COVSAFE/delivery

# do only when using c4c dummy generator
# generate assets for an imaginary shopping mall
cd ./data/tenants/c4c/tools
npm install && npm start
rm -rf node_modules package-lock.json

# create staff for an imaginary shopping mall
python3 create-assets-staff.py
```

## How to deploy

1. Do commands below and have a coffee break. It creates almost services that we use in IBM Cloud.

```sh
export APIKEY=${YOUR_API_KEY}
cd /path/to/COVSAFE/delivery
cd scripts
pipenv install

# change some variables for your env, like resource group
pipenv run python main.py -o create -p covsafe -t c4c -r jp-tok -g covid-19-dev
```

2. Deploy Push Notifications

If you have MESH LED device and wish to try it with our applicatin, please follow the below instructions.

- [push-notifications](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/push-notifications#installations-and-configurations)

3. Deploy Functions

See README of each repo to get known how to buid and deploy the functions. All functions require the Cloudant secret, and parts of them need either Cloud Object Storage or Event Streams secret. Please get those secret from `/path/to/COVSAFE/delivery/scripts/.credentials` created after you run `main.py` above.

- [data-proxy](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/data-proxy#how-to-deploy-the-data-proxy)
  - assumes in `/path/to/COVSAFE/data-proxy`  localy
  - required secrets
    - CLOUDANT_WRITER_CREDENTIALS
    - CLOUDANT_READER_CREDENTIALS
    - COS_READER_CREDENTIALS
    - COS_WRITER_CREDENTIALS
- [risk-calculator](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/risk-calculator#implementation-steps)
  - assumes in `/path/to/COVSAFE/risk-calculator` localy
  - required secrets
    - CLOUDANT_WRITER_CREDENTIALS
    - CLOUDANT_READER_CREDENTIALS
- [risk-notifier](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/risk-notifier)
  - assumes in `/path/to/COVSAFE/risk-notifier` localy
  - required secrets
    - CLOUDANT_WRITER_CREDENTIALS
    - CLOUDANT_READER_CREDENTIALS
- [data-recorder](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/data-recorder#how-to-install-and-setup)
  - assumes in `/path/to/COVSAFE/data-recorder` localy
  - required secrets
    - EVENT_STREAMS_READER_CREDENTIALS
    - CLOUDANT_WRITER_CREDENTIALS

4. Deploy covsafe-view

Go to [covsafe-view](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/covsafe-view#how-to-start) or `/path/to/COVSAFE/covsafe-view` and see the README. For demonstration, it's recommended to take steps of "How To Build" > "Prod Mode" and "How to Deploy to IBM Cloud."

5. Deploy mobile apps

If you have MESH LED device and wish to try it with our applicatin, please follow the instuctions shown in README of each repos below.

- [mobile-app](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/mobile-app)
- [indicator](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/indicator)

6. Deploy edge devices

If you have sensors that our application support, named HLS-LFOM5 or HLS-LFOM1, and would like to try it with our application, please follow the instructions shown in README of a repo below.

- [edge-data-collector](https://github.com/Hitachi-CTI-Call-For-Code-COVID-19-Team/edge-data-collector)

7. Check it

After your deployment of covsafe-view, covsafe-view URL should be shown with the keyword "Please access to:". Access to the URL with login credentials. If you don't change the default username and password, just use username: "user@fake.email" and password "password".

## How to create dummy data

If you use the tenant "c4c", we prepare the dummy data generator of the sensors that are imagined to be placed at the imaginary shopping mall to have a fun without any physical sensors. If you would like to get it, kick these commands below.

```sh
export APIKEY=YOUR_API_KEY
cd /path/to/COVSAFE/delivery
cd scripts
# change some variables for your env, like resource group
pipenv run python function_dummy_generator.py -o create -r jp-tok -g covid-19-dev -n dummy-generator -p dummy-generator -a dummy-generator -t dummy-generator-trigger -u dummy-generator-rule -c ./.credentials
```

## How to delete COVSAFE

```sh
# dploy covsafe solution
export APIKEY=YOUR_API_KEY
cd /path/to/COVSAFE/delivery
cd scripts
pipenv install

# change some variables for your env, like resource group
pipenv run python main.py -o delete -p covsafe -t c4c -r jp-tok -g covid-19-dev
```
